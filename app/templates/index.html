<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workhorse - Solana Trading Bot</title>
    
    <!-- CSS -->
    <style>
        :root {
            --primary: #14f195;
            --primary-dark: #00d182;
            --secondary: #8b5cf6;
            --background: #0f0f23;
            --surface: #1a1a3e;
            --surface-light: #242454;
            --text: #ffffff;
            --text-muted: #a0a0b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #2d2d5f;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 0.5rem; /* Add spacing between badges */
        }
        
        .status-running { background: var(--success); color: white; }
        .status-stopped { background: var(--error); color: white; }
        .status-paper { background: var(--warning); color: black; }
        
        /* Badges for arbitrage section */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .badge-success { background: var(--success); color: white; }
        .badge-info { background: var(--secondary); color: white; }
        .badge-warning { background: var(--warning); color: black; }
        
        /* Settings button for mode switching */
        .settings-btn {
            background: var(--surface-light);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.75rem;
            margin-left: 0.5rem;
            transition: all 0.2s;
        }
        
        .settings-btn:hover {
            background: var(--border);
        }
        
        /* Wallet info in header */
        .wallet-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-right: 1rem;
        }
        
        .wallet-address {
            font-family: monospace;
            font-size: 0.7rem;
        }
        
        .wallet-balance {
            font-weight: 600;
            color: var(--success);
        }
        
        .wallet-pnl {
            font-weight: 600;
            color: var(--success);
        }
        
        .wallet-pnl.negative {
            color: var(--error);
        }
        
        /* Enhanced wallet balance display */
        .wallet-balances {
            font-size: 0.75rem;
            line-height: 1.2;
        }

        .wallet-balances .wallet-balance {
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
        }

        .wallet-balances .wallet-balance:nth-child(1) {
            color: var(--primary); /* SOL - primary color */
        }

        .wallet-balances .wallet-balance:nth-child(2) {
            color: var(--success); /* USDC - green */
        }

        .wallet-balances .wallet-balance:nth-child(3) {
            color: var(--secondary); /* USDT - purple */
        }
        
        /* Grid System */
        .grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .grid-cols-1 { grid-template-columns: 1fr; }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        
        /* Portfolio & Trades Grid Layout */
        .portfolio-trades-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* Arbitrage Trades Full Width */
        .arbitrage-trades-section {
            margin-bottom: 2rem;
        }
        
        /* Table Container Improvements */
        .table-container {
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            background: var(--background);
            overflow: hidden;
        }
        
        .table-container.recent-trades {
            max-height: 250px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .table-container.arbitrage-trades {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: auto;
        }
        
        /* Enhanced Table Styles */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            background: var(--background);
            font-size: 0.875rem;
        }
        
        .table th {
            background: var(--surface);
            color: var(--text);
            font-weight: 600;
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        
        .table tbody tr:hover {
            background: var(--surface);
        }
        
        .table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Table responsive adjustments */
        .table th:first-child,
        .table td:first-child {
            padding-left: 1.25rem;
        }
        
        .table th:last-child,
        .table td:last-child {
            padding-right: 1.25rem;
        }
        
        /* Status indicators in tables */
        .table .status-success {
            color: var(--success);
            font-weight: 600;
        }
        
        .table .status-error {
            color: var(--error);
            font-weight: 600;
        }
        
        .table .text-muted {
            color: var(--text-muted);
        }
        
        .table .text-center {
            text-align: center;
        }
        
        /* Responsive Tables */
        @media (max-width: 1200px) {
            .portfolio-trades-grid {
                grid-template-columns: 1fr;
            }
            
            .table-container.arbitrage-trades {
                overflow-x: auto;
            }
            
            .grid-cols-3 {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .table-container.recent-trades,
            .table-container.arbitrage-trades {
                max-height: 300px;
            }
            
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--background);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h2 {
            margin: 0;
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
        }
        
        /* For metric cards and cards without tables */
        .card.metric {
            padding: 1.5rem;
            text-align: center;
        }
        
        .card.metric .card-header {
            padding: 0;
            border-bottom: none;
            background: transparent;
            margin-bottom: 1rem;
        }
        
        /* Cards with just content (no tables) */
        .card.content-only {
            padding: 1.5rem;
        }
        
        .card.content-only .card-header {
            padding: 0;
            border-bottom: none;
            background: transparent;
            margin-bottom: 1rem;
        }
        
        .metric {
            text-align: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.25rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--background);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: var(--surface-light);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: var(--error);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-disabled {
            background: #6b7280 !important;
            color: #9ca3af !important;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }
        
        .btn-disabled:hover {
            background: #6b7280 !important;
            color: #9ca3af !important;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--card-radius, 0.75rem);
            max-width: 600px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--error);
        }
        
        .close-btn {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s;
        }
        
        .close-btn:hover {
            color: var(--text);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .alert-details {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .alert-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .alert-actions .btn {
            flex: 1;
        }
        
        /* Notification Styles */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
            max-width: 400px;
        }
        
        .notification {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
        }
        
        .notification.error {
            border-left: 4px solid var(--error);
        }
        
        .notification.warning {
            border-left: 4px solid var(--warning);
        }
        
        .notification.success {
            border-left: 4px solid var(--success);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .notification-close {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.2rem;
        }
        
        .notification-message {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Toast notifications container -->
    <div class="toast-container" id="toast-container"></div>
    
    <header>
        <div class="container">
            <div class="header-content">
                <h1>üêé Workhorse</h1>
                
                <!-- Wallet Portfolio Info -->
                <div class="wallet-info">
                    <div class="wallet-address" id="wallet-address">Wallet: --</div>
                    <div class="wallet-balance-section" style="display: flex; align-items: center; gap: 0.5rem;">
                        <div class="wallet-balances" style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.2rem;">
                            <div class="wallet-balance" id="wallet-balance-sol">SOL: --</div>
                            <div class="wallet-balance" id="wallet-balance-usdc">USDC: --</div>
                            <div class="wallet-balance" id="wallet-balance-usdt">USDT: --</div>
                        </div>
                        <button id="refresh-balance-btn" class="btn btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: var(--surface-light); border: 1px solid var(--border); color: var(--text);" onclick="refreshWalletBalance()">
                            üîÑ
                        </button>
                    </div>
                    <div class="wallet-pnl" id="wallet-pnl">PnL: --</div>
                </div>
                
                <!-- Status and Mode Controls -->
                <div style="display: flex; align-items: center;">
                    <span id="status-badge" class="status-badge status-stopped">Initializing</span>
                    <button class="settings-btn" onclick="toggleTradingMode()" title="Switch between Paper and MainNet mode">
                        ‚öôÔ∏è <span id="mode-text">PAPER</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Key Metrics -->
        <div class="grid grid-cols-3">
            <div class="card metric">
                <div class="metric-value" id="portfolio-value">--</div>
                <div class="metric-label">Portfolio Value</div>
            </div>
            <div class="card metric">
                <div class="metric-value" id="total-pnl">--</div>
                <div class="metric-label">Total P&L</div>
            </div>
            <div class="card metric">
                <div class="metric-value" id="uptime">--</div>
                <div class="metric-label">Uptime</div>
            </div>
        </div>

        <!-- Status and Refresh -->
        <div class="card content-only">
            <div class="card-header">
                <h2 class="card-title">Arbitrage Bot Status</h2>
                <div id="connection-status" class="text-muted">
                    <span class="loading"></span> Connecting...
                </div>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button id="start-bot" class="btn btn-success" onclick="startBot()" style="display: none;">
                    ‚ñ∂Ô∏è Start Bot
                </button>
                <button id="stop-bot" class="btn btn-error" onclick="stopBot()" style="display: none;">
                    ‚èπÔ∏è Stop Bot
                </button>
                <button id="refresh-data" class="btn btn-primary" onclick="refreshData()">
                    Refresh Data
                </button>
                <button id="check-funds" class="btn btn-secondary" onclick="checkFunds()">
                    üîç Check Funds
                </button>
                <button id="fund-wallet" class="btn btn-success" onclick="showWalletQR()">
                    üí∞ Fund Wallet
                </button>
            </div>
        </div>
            <style>
                /* Tooltip styles */
                .tooltip {
                    position: relative;
                    display: inline-flex;
                    align-items: center;
                    margin-left: 5px;
                    cursor: help;
                }
                
                .tooltip:hover::after {
                    content: attr(data-tooltip);
                    position: absolute;
                    left: 50%;
                    transform: translateX(-50%);
                    bottom: 100%;
                    background-color: rgba(13, 17, 47, 0.95);
                    color: #fff;
                    text-align: left;
                    border-radius: 4px;
                    padding: 8px 12px;
                    width: max-content;
                    max-width: 350px;
                    z-index: 100;
                    font-size: 0.85rem;
                    white-space: normal;
                    border: 1px solid var(--error);
                    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.4);
                    margin-bottom: 8px;
                    line-height: 1.5;
                    word-break: break-word;
                }
                
                .info-icon {
                    width: 16px;
                    height: 16px;
                    color: var(--error);
                    filter: drop-shadow(0 0 2px rgba(239, 68, 68, 0.3));
                }
                
                /* Trade row with error styling */
                tr.has-error {
                    background-color: rgba(239, 68, 68, 0.05);
                    transition: all 0.2s;
                    border-left: 2px solid var(--error);
                }
                
                tr.has-error:hover {
                    background-color: rgba(239, 68, 68, 0.1);
                    transform: translateX(2px);
                }
                
                /* Badge styles for error */
                .badge-error {
                    background-color: var(--error);
                    color: white;
                }
                
                /* Animation for failed trades */
                @keyframes highlight-error {
                    0% { background-color: rgba(239, 68, 68, 0); }
                    50% { background-color: rgba(239, 68, 68, 0.2); }
                    100% { background-color: rgba(239, 68, 68, 0.05); }
                }
                
                tr.has-error.new-error {
                    animation: highlight-error 1.5s ease-out;
                }
                
                /* Animation for successful trades */
                @keyframes highlight-success {
                    0% { background-color: rgba(20, 241, 149, 0); }
                    50% { background-color: rgba(20, 241, 149, 0.15); }
                    100% { background-color: rgba(20, 241, 149, 0); }
                }
                
                tr.new-success {
                    animation: highlight-success 1.5s ease-out;
                }
            </style>
            </div>
        </div>

        <!-- Portfolio & Recent Trades -->
        <div class="portfolio-trades-grid">
            <!-- Portfolio -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Portfolio</h2>
                </div>
                <div style="padding: 1.5rem;">
                    <table class="table">
                        <tbody>
                            <tr>
                                <td>SOL Balance</td>
                                <td id="sol-balance">--</td>
                            </tr>
                            <tr>
                                <td>USDC Balance</td>
                                <td id="usdc-balance">--</td>
                            </tr>
                            <tr>
                                <td>USDT Balance</td>
                                <td id="usdt-balance">--</td>
                            </tr>
                            <tr>
                                <td>Total USD Value</td>
                                <td id="total-value">--</td>
                            </tr>
                            <tr>
                                <td>Unrealized P&L</td>
                                <td id="unrealized-pnl">--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Trades -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent Trades</h2>
                </div>
                <div class="table-container recent-trades">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Action</th>
                                <th>Amount</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table">
                            <tr>
                                <td colspan="4" class="text-muted text-center">No trades yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Arbitrage Trades Section -->
        <div class="card arbitrage-trades-section">
            <div class="card-header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <svg style="width: 24px; height: 24px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M15 10l5 5-5 5"></path>
                        <path d="M4 4v7a4 4 0 0 0 4 4h12"></path>
                        <path d="M9 14l-5-5 5-5"></path>
                        <path d="M20 20v-7a4 4 0 0 0-4-4H4"></path>
                    </svg>
                    <h2 class="card-title">Arbitrage Trades</h2>
                    <button id="test-trades-btn" class="btn btn-secondary" style="margin-left: auto; padding: 4px 8px; font-size: 12px;" onclick="injectTestTrades()">
                        üß™ Test Trades
                    </button>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 0.5rem;">
                    <span id="arbitrage-profit" class="badge badge-success" style="display: flex; align-items: center;">
                        <svg style="width: 16px; height: 16px; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                        </svg>
                        Total Profit: $0.00
                    </span>
                    <span id="arbitrage-count" class="badge badge-info" style="display: flex; align-items: center;">
                        <svg style="width: 14px; height: 14px; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"></path>
                            <path d="M18 17V9"></path>
                            <path d="M13 17V5"></path>
                            <path d="M8 17v-3"></path>
                        </svg>
                        Trades: 0
                    </span>
                    <span id="arbitrage-success-rate" class="badge badge-warning" style="display: flex; align-items: center;">
                        <svg style="width: 14px; height: 14px; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <path d="M22 4L12 14.01l-3-3"></path>
                        </svg>
                        Success Rate: 0%
                    </span>
                </div>
            </div>
            <div class="table-container arbitrage-trades">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Pair</th>
                            <th>Buy DEX</th>
                            <th>Sell DEX</th>
                            <th>Amount</th>
                            <th>Profit</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="arbitrage-trades-table">
                        <tr>
                            <td colspan="7" class="text-muted text-center">No arbitrage trades yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Funds Alert Modal -->
    <div id="funds-alert-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="alert-title">‚ö†Ô∏è Insufficient Funds</h3>
                <span class="close-btn" onclick="closeFundsAlert()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="alert-message"></div>
                <div id="alert-details" class="alert-details"></div>
                <div class="alert-actions">
                    <button class="btn btn-primary" onclick="window.open('MAINNET_GUIDE.md', '_blank')">
                        üìñ View Funding Guide
                    </button>
                    <button class="btn btn-secondary" onclick="closeFundsAlert()">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet QR Code Modal -->
    <div id="wallet-qr-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí∞ Fund Your Wallet</h3>
                <span class="close-btn" onclick="closeWalletQR()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="text-align: center;">
                    <p><strong>Send SOL or USDT to this address:</strong></p>
                    <div id="wallet-address-display" style="background: var(--surface-light); padding: 1rem; border-radius: 8px; margin: 1rem 0; font-family: monospace; word-break: break-all; border: 1px solid var(--border);">
                        Loading...
                    </div>
                    <div id="qr-code-container" style="display: flex; justify-content: center; margin: 1.5rem 0;">
                        <!-- QR code will be generated here -->
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-secondary" onclick="copyWalletAddress()">
                            üìã Copy Address
                        </button>
                        <button class="btn btn-primary" onclick="checkFunds(); closeWalletQR();">
                            üîç Check Balance
                        </button>
                    </div>
                    <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                        <p><strong>Supported tokens:</strong></p>
                        <p>‚Ä¢ SOL (for transaction fees)</p>
                        <p>‚Ä¢ USDT (for trading)</p>
                        <p>‚Ä¢ USDC (for trading)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Socket.IO -->
    <!-- JavaScript Libraries -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        // Error handling
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('JavaScript Error:', msg, 'at', url + ':' + lineNo + ':' + columnNo);
            return false;
        };
        
        // Current price functionality
        function getCurrentPrice() {
            fetch('/api/price')
                .then(response => response.json())
                .then(data => {
                    if (data && data.price) {
                        console.log(`Current price updated: $${data.price}`);
                    }
                })
                .catch(error => {
                    console.error('Error fetching current price:', error);
                });
        }
        
        // Simple debug function that just checks the price API
        function debugPrice() {
            fetch('/api/price')
                .then(response => response.json())
                .then(data => {
                    console.log('Price API debug:', data);
                    alert(`Current SOL price: $${data.price ? parseFloat(data.price).toFixed(2) : 'N/A'}`);
                })
                .catch(error => {
                    console.error('Debug error:', error);
                    alert('Error debugging price: ' + error);
                });
        }

        // Trading mode toggle
        let currentMode = 'paper'; // Default to paper mode
        
        async function toggleTradingMode() {
            const newMode = currentMode === 'paper' ? 'mainnet' : 'paper';
            const modeText = document.getElementById('mode-text');
            const settingsBtn = document.querySelector('.settings-btn');
            
            try {
                // Show loading state
                modeText.textContent = 'SWITCHING...';
                settingsBtn.disabled = true;
                
                // Make API call to change mode
                const response = await fetch('/api/trading/mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mode: newMode
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update current mode
                    currentMode = newMode;
                    
                    // Update UI
                    if (currentMode === 'mainnet') {
                        modeText.textContent = 'MAINNET';
                        settingsBtn.style.background = 'var(--error)';
                        settingsBtn.style.color = 'white';
                        settingsBtn.style.borderColor = 'var(--error)';
                    } else {
                        modeText.textContent = 'PAPER';
                        settingsBtn.style.background = 'var(--surface-light)';
                        settingsBtn.style.color = 'var(--text)';
                        settingsBtn.style.borderColor = 'var(--border)';
                    }
                    
                    console.log('Trading mode switched to:', currentMode.toUpperCase());
                    
                    // Show success notification
                    showNotification({
                        type: 'success',
                        title: 'Mode Changed',
                        message: `Trading mode switched to ${currentMode.toUpperCase()}`
                    });
                    
                    // Request updated data
                    requestUpdate();
                    
                } else {
                    // Revert UI on error
                    modeText.textContent = currentMode.toUpperCase();
                    
                    // Show error notification
                    showNotification({
                        type: 'error',
                        title: 'Mode Change Failed',
                        message: data.error || 'Failed to change trading mode'
                    });
                    
                    console.error('Failed to change trading mode:', data.error);
                }
                
            } catch (error) {
                // Revert UI on error
                modeText.textContent = currentMode.toUpperCase();
                
                // Show error notification
                showNotification({
                    type: 'error',
                    title: 'Connection Error',
                    message: 'Failed to connect to server'
                });
                
                console.error('Error changing trading mode:', error);
            } finally {
                // Re-enable button
                settingsBtn.disabled = false;
            }
        }
        
        // Request initial data function
        function requestUpdate() {
            if (typeof socket !== 'undefined' && socket.connected) {
                console.log('üöÄ Emitting request_update');
                socket.emit('request_update');
            }
        }

        // Data refresh function
        function refreshData() {
            console.log('üîÑ Refreshing data...');
            requestUpdate();
        }

        // Wallet balance refresh function
        async function refreshWalletBalance() {
            const refreshBtn = document.getElementById('refresh-balance-btn');
            if (!refreshBtn) {
                console.error('Refresh button not found');
                return;
            }
            
            const originalText = refreshBtn.innerHTML;
            
            try {
                // Show loading state
                refreshBtn.innerHTML = '‚è≥';
                refreshBtn.disabled = true;
                
                // Update balance displays to show loading (with null checks)
                const solEl = document.getElementById('wallet-balance-sol');
                const usdcEl = document.getElementById('wallet-balance-usdc');
                const usdtEl = document.getElementById('wallet-balance-usdt');
                
                if (solEl) solEl.textContent = 'SOL: Loading...';
                if (usdcEl) usdcEl.textContent = 'USDC: Loading...';
                if (usdtEl) usdtEl.textContent = 'USDT: Loading...';
                
                // Call the refresh API
                const response = await fetch('/api/wallet/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the balance display - use wallet_info.balances instead of wallet_info directly
                    const balances = result.wallet_info && result.wallet_info.balances ? result.wallet_info.balances : result.wallet_info;
                    updateWalletBalance(balances);
                    
                    // Show success message with all balances
                    let message = 'Balances updated:';
                    if (balances && typeof balances === 'object') {
                        message += ` SOL: ${(balances.SOL || 0).toFixed(4)}, USDC: ${(balances.USDC || 0).toFixed(2)}, USDT: ${(balances.USDT || 0).toFixed(2)}`;
                    } else {
                        message += ` ${balances} SOL`;
                    }
                    
                    showNotification({
                        title: '‚úÖ Balances Refreshed',
                        type: 'success',
                        message: message
                    });
                } else {
                    showNotification({
                        title: '‚ùå Refresh Failed',
                        type: 'error',
                        message: result.message || 'Failed to refresh balance'
                    });
                }
                
            } catch (error) {
                console.error('Error refreshing balance:', error);
                showNotification({
                    title: '‚ùå Error',
                    type: 'error',
                    message: 'Failed to refresh balance'
                });
            } finally {
                // Restore button state
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }
        }

        // Update wallet balance display
        function updateWalletBalance(balances) {
            console.log('updateWalletBalance called with:', balances);
            
            if (balances && typeof balances === 'object') {
                // Multiple balances format
                const solBalance = parseFloat(balances.SOL || 0);
                const usdcBalance = parseFloat(balances.USDC || 0);
                const usdtBalance = parseFloat(balances.USDT || 0);
                
                // Update header balances (with null checks)
                const solEl = document.getElementById('wallet-balance-sol');
                const usdcEl = document.getElementById('wallet-balance-usdc');
                const usdtEl = document.getElementById('wallet-balance-usdt');
                
                if (solEl) solEl.textContent = `SOL: ${solBalance.toFixed(4)}`;
                if (usdcEl) usdcEl.textContent = `USDC: ${usdcBalance.toFixed(2)}`;
                if (usdtEl) usdtEl.textContent = `USDT: ${usdtBalance.toFixed(2)}`;
                
                // Update portfolio section (with null checks)
                const portfolioSolEl = document.getElementById('sol-balance');
                const portfolioUsdcEl = document.getElementById('usdc-balance');
                const portfolioUsdtEl = document.getElementById('usdt-balance');
                
                if (portfolioSolEl) portfolioSolEl.textContent = `${solBalance.toFixed(4)} SOL`;
                if (portfolioUsdcEl) portfolioUsdcEl.textContent = `${usdcBalance.toFixed(2)} USDC`;
                if (portfolioUsdtEl) portfolioUsdtEl.textContent = `${usdtBalance.toFixed(2)} USDT`;
                
            } else if (typeof balances === 'number') {
                // Legacy single balance format (SOL only)
                const solEl = document.getElementById('wallet-balance-sol');
                const portfolioSolEl = document.getElementById('sol-balance');
                
                if (solEl) solEl.textContent = `SOL: ${balances.toFixed(4)}`;
                if (portfolioSolEl) portfolioSolEl.textContent = `${balances.toFixed(4)} SOL`;
            }
        }

        // Update wallet information
        function updateWalletInfo(walletData) {
            console.log('updateWalletInfo function called with:', walletData);
            if (!walletData) {
                console.error('updateWalletInfo called with no data');
                
                // Safely update elements with null checks
                const addressEl = document.getElementById('wallet-address');
                const solEl = document.getElementById('wallet-balance-sol');
                const usdcEl = document.getElementById('wallet-balance-usdc');
                const usdtEl = document.getElementById('wallet-balance-usdt');
                const pnlEl = document.getElementById('wallet-pnl');
                
                if (addressEl) addressEl.textContent = 'Wallet: --';
                if (solEl) solEl.textContent = 'SOL: --';
                if (usdcEl) usdcEl.textContent = 'USDC: --';
                if (usdtEl) usdtEl.textContent = 'USDT: --';
                if (pnlEl) pnlEl.textContent = 'PnL: --';
                return;
            }
            
            const walletAddressEl = document.getElementById('wallet-address');
            const walletBalanceSolEl = document.getElementById('wallet-balance-sol');
            const walletBalanceUsdcEl = document.getElementById('wallet-balance-usdc');
            const walletBalanceUsdtEl = document.getElementById('wallet-balance-usdt');
            const walletPnlEl = document.getElementById('wallet-pnl');
            
            // Update wallet address (with null check)
            if (walletAddressEl) {
                if (walletData.address) {
                    const truncatedAddress = walletData.address.slice(0, 4) + '...' + walletData.address.slice(-4);
                    walletAddressEl.textContent = `Wallet: ${truncatedAddress}`;
                } else {
                    walletAddressEl.textContent = 'Wallet: Not available';
                }
            }
            
            // Handle multiple balances format
            if (walletData.balances && typeof walletData.balances === 'object') {
                // New format with multiple balances
                const solBalance = parseFloat(walletData.balances.SOL || 0);
                const usdcBalance = parseFloat(walletData.balances.USDC || 0);
                const usdtBalance = parseFloat(walletData.balances.USDT || 0);
                
                if (walletBalanceSolEl) walletBalanceSolEl.textContent = `SOL: ${solBalance.toFixed(4)}`;
                if (walletBalanceUsdcEl) walletBalanceUsdcEl.textContent = `USDC: ${usdcBalance.toFixed(2)}`;
                if (walletBalanceUsdtEl) walletBalanceUsdtEl.textContent = `USDT: ${usdtBalance.toFixed(2)}`;
                
                // Update portfolio section (with null checks)
                const portfolioSolEl = document.getElementById('sol-balance');
                const portfolioUsdcEl = document.getElementById('usdc-balance');
                const portfolioUsdtEl = document.getElementById('usdt-balance');
                
                if (portfolioSolEl) portfolioSolEl.textContent = `${solBalance.toFixed(4)} SOL`;
                if (portfolioUsdcEl) portfolioUsdcEl.textContent = `${usdcBalance.toFixed(2)} USDC`;
                if (portfolioUsdtEl) portfolioUsdtEl.textContent = `${usdtBalance.toFixed(2)} USDT`;
                
            } else if (walletData.balance !== undefined && walletData.balance !== null) {
                // Legacy format with single balance (SOL)
                const balance = parseFloat(walletData.balance);
                if (!isNaN(balance)) {
                    if (walletBalanceSolEl) walletBalanceSolEl.textContent = `SOL: ${balance.toFixed(4)}`;
                    
                    const portfolioSolEl = document.getElementById('sol-balance');
                    if (portfolioSolEl) portfolioSolEl.textContent = `${balance.toFixed(4)} SOL`;
                } else {
                    if (walletBalanceSolEl) walletBalanceSolEl.textContent = 'SOL: Format error';
                }
                
                // Set USDC and USDT to defaults for legacy format
                if (walletBalanceUsdcEl) walletBalanceUsdcEl.textContent = 'USDC: 0.00';
                if (walletBalanceUsdtEl) walletBalanceUsdtEl.textContent = 'USDT: 0.00';
                
                const portfolioUsdcEl = document.getElementById('usdc-balance');
                const portfolioUsdtEl = document.getElementById('usdt-balance');
                if (portfolioUsdcEl) portfolioUsdcEl.textContent = '0.00 USDC';
                if (portfolioUsdtEl) portfolioUsdtEl.textContent = '0.00 USDT';
            } else {
                // No balance data
                if (walletBalanceSolEl) walletBalanceSolEl.textContent = 'SOL: 0.0000';
                if (walletBalanceUsdcEl) walletBalanceUsdcEl.textContent = 'USDC: 0.00';
                if (walletBalanceUsdtEl) walletBalanceUsdtEl.textContent = 'USDT: 0.00';
                
                const portfolioSolEl = document.getElementById('sol-balance');
                const portfolioUsdcEl = document.getElementById('usdc-balance');
                const portfolioUsdtEl = document.getElementById('usdt-balance');
                
                if (portfolioSolEl) portfolioSolEl.textContent = '0.0000 SOL';
                if (portfolioUsdcEl) portfolioUsdcEl.textContent = '0.00 USDC';
                if (portfolioUsdtEl) portfolioUsdtEl.textContent = '0.00 USDT';
            }
            
            // Update PnL (with null check)
            if (walletPnlEl) {
                if (walletData.pnl !== undefined && walletData.pnl !== null) {
                    const pnl = parseFloat(walletData.pnl);
                    if (!isNaN(pnl)) {
                        walletPnlEl.textContent = `PnL: ${pnl > 0 ? '+' : ''}${pnl.toFixed(4)} USDC`;
                        walletPnlEl.classList.toggle('negative', pnl < 0);
                    } else {
                        walletPnlEl.textContent = 'PnL: --';
                    }
                } else {
                    walletPnlEl.textContent = 'PnL: 0.0000 USDC';
                }
            }
        }

        // Notification system
        function showNotification(notification) {
            const container = document.getElementById('notification-container');
            if (!container) return;
            
            const notificationEl = document.createElement('div');
            notificationEl.className = `notification ${notification.type || 'info'}`;
            
            notificationEl.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">${notification.title || 'Notification'}</div>
                    <span class="notification-close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                </div>
                <div class="notification-message">${notification.message}</div>
            `;
            
            container.appendChild(notificationEl);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notificationEl.parentElement) {
                    notificationEl.remove();
                }
            }, 10000);
        }

        let isTradingActive = false;
        const statusBadge = document.getElementById('status-badge');

        function startBot() {
            console.log('‚ñ∂Ô∏è Attempting to start bot...');
            if (typeof socket !== 'undefined' && socket.connected) {
                socket.emit('start_trading');
            } else {
                console.error('‚ùå Socket not connected, cannot start bot.');
                alert('Not connected to server. Cannot start bot.');
            }
        }

        function stopBot() {
            console.log('üõë Attempting to stop bot...');
            if (typeof socket !== 'undefined' && socket.connected) {
                socket.emit('stop_trading');
            } else {
                console.error('‚ùå Socket not connected, cannot stop bot.');
                alert('Not connected to server. Cannot stop bot.');
            }
        }

        function updateTradingStatus(isActive, currentStatusText = null) {
            isTradingActive = isActive;
            const startBtn = document.getElementById('start-bot');
            const stopBtn = document.getElementById('stop-bot');
            
            // Update status badge
            if (statusBadge) {
                if (currentStatusText) {
                    statusBadge.textContent = currentStatusText;
                    
                    // Set appropriate class based on status
                    statusBadge.className = 'status-badge '; // Reset classes
                    if (currentStatusText.toLowerCase() === 'running') {
                        statusBadge.classList.add('status-running');
                    } else if (currentStatusText.toLowerCase() === 'stopped') {
                        statusBadge.classList.add('status-stopped');
                    } else if (currentStatusText.toLowerCase() === 'starting') {
                        statusBadge.classList.add('status-running'); // Use running style for starting
                    } else if (currentStatusText.toLowerCase() === 'stopping') {
                        statusBadge.classList.add('status-stopped'); // Use stopped style for stopping
                    } else {
                        statusBadge.classList.add('status-stopped'); // Default to stopped
                    }
                } else {
                    statusBadge.textContent = isTradingActive ? 'Running' : 'Stopped';
                    statusBadge.className = 'status-badge '; // Reset classes
                    statusBadge.classList.add(isTradingActive ? 'status-running' : 'status-stopped');
                }
            }
            
            // Update button visibility based on actual status
            if (startBtn && stopBtn) {
                const status = currentStatusText ? currentStatusText.toLowerCase() : (isTradingActive ? 'running' : 'stopped');
                
                if (status === 'running') {
                    // Bot is running - show stop button
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = '‚èπÔ∏è Stop Bot';
                } else if (status === 'stopped') {
                    // Bot is stopped - show start button
                    startBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    startBtn.disabled = false;
                    startBtn.innerHTML = '‚ñ∂Ô∏è Start Bot';
                } else if (status === 'starting') {
                    // Bot is starting - show stop button (disabled) and hide start
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                    stopBtn.disabled = true; // Disable while starting
                    stopBtn.innerHTML = '‚è≥ Starting...';
                } else if (status === 'stopping') {
                    // Bot is stopping - show start button (disabled) and hide stop
                    startBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    startBtn.disabled = true; // Disable while stopping
                    startBtn.innerHTML = '‚è≥ Stopping...';
                }
            }
            
            console.log(`Trading status updated: Active = ${isTradingActive}, Status = ${currentStatusText}, Badge = ${statusBadge.textContent}`);
        }
        
        // Initialize Socket.IO connection
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;
        const port = window.location.port || (protocol === 'https:' ? 443 : 80);
        const socketUrl = `${protocol}//${hostname}:${port}`;
        
        console.log(`Connecting to Socket.IO at ${socketUrl}`);
        
        var socket = io(socketUrl, {
            transports: ['websocket', 'polling'],
            rejectUnauthorized: false,
            secure: protocol === 'https:',
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            timeout: 20000
        });

        socket.on('connect', () => {
            console.log('üîó Socket.IO connected!');
            document.getElementById('connection-status').innerHTML = '<span style="color: var(--success);">‚óè</span> Connected';
            
            // Ensure status badge gets updated from initializing state
            if (statusBadge.textContent === "Initializing") {
                statusBadge.textContent = "Connected";
                statusBadge.className = 'status-badge status-stopped';
            }
            
            requestUpdate(); // Request initial data
        });

        socket.on('disconnect', () => {
            console.log('üîå Socket.IO disconnected!');
            document.getElementById('connection-status').innerHTML = '<span style="color: var(--error);">‚óè</span> Disconnected';
            updateTradingStatus(false, 'Disconnected');
            statusBadge.className = 'status-badge status-stopped';
        });

        socket.on('connect_error', (err) => {
            console.error('üîó Socket.IO connection error:', err);
            document.getElementById('connection-status').innerHTML = '<span style="color: var(--error);">‚óè</span> Connection Failed';
            updateTradingStatus(false, 'Error');
            statusBadge.className = 'status-badge status-stopped';
        });

        // Debug: Log ALL incoming Socket.IO events
        socket.onAny((eventName, ...args) => {
            console.log('üîî Socket.IO event received:', eventName, args);
        });

        socket.on('price_update', function(data) {
            console.log('üìà Received price_update:', data);
            if (socket && socket.connected) {
                console.log('üìä Requesting status update after price update');
                socket.emit('request_update');
            }
        });

        socket.on('status_update', function(data) {
            console.log('‚ÑπÔ∏è Received status_update data from backend:', data);

            if (data.status) {
                const isActive = data.status.toLowerCase() === 'running';
                updateTradingStatus(isActive, data.status);
            }
            
            if (data.mode) {
                currentMode = data.mode.toLowerCase();
                const modeText = document.getElementById('mode-text');
                const settingsBtn = document.querySelector('.settings-btn');
                if (currentMode === 'mainnet') {
                    modeText.textContent = 'MAINNET';
                    settingsBtn.style.background = 'var(--error)';
                    settingsBtn.style.color = 'white';
                    settingsBtn.style.borderColor = 'var(--error)';
                } else {
                    modeText.textContent = 'PAPER';
                    settingsBtn.style.background = 'var(--surface-light)';
                    settingsBtn.style.color = 'var(--text)';
                    settingsBtn.style.borderColor = 'var(--border)';
                }
            }
            
            // Update portfolio value safely
            if (data.portfolio_value !== undefined) {
                const portfolioEl = document.getElementById('portfolio-value');
                if (portfolioEl) {
                    portfolioEl.textContent = `$${parseFloat(data.portfolio_value).toFixed(2)}`;
                }
            }
            
            if (data.total_pnl !== undefined) {
                const pnlElement = document.getElementById('unrealized-pnl');
                if (pnlElement) {
                    const pnlValue = parseFloat(data.total_pnl);
                    pnlElement.textContent = `$${pnlValue.toFixed(2)}`;
                    pnlElement.className = pnlValue >= 0 ? 'text-success' : 'text-error';
                }
            }
            
            if (data.uptime) {
                const uptimeEl = document.getElementById('uptime');
                if (uptimeEl) {
                    uptimeEl.textContent = data.uptime;
                }
            }
            
            if (data.wallet_info) {
                console.log('Wallet info received from backend via status_update:', data.wallet_info);
                updateWalletInfo(data.wallet_info);
            } else {
                console.log('No wallet_info in received status_update data.');
            }
            
            // Update trades data
            if (data.recent_trades) {
                console.log('Recent trades received from backend:', data.recent_trades);
                updateTradesDisplay(data.recent_trades);
            }
            
            // Update trade counters
            if (data.trades_executed !== undefined) {
                updateTradeCounters(data.trades_executed, data.total_pnl);
            }
        });

        // Handle real-time trade updates
        socket.on('trade_update', function(data) {
            console.log('üí∞ Received trade_update:', data);
            
            // If the trade update contains individual trade data, refresh the trades display
            if (data.trade) {
                console.log('Processing individual trade update:', data.trade);
                // Request a full status update to get all recent trades
                if (socket && socket.connected) {
                    socket.emit('request_update');
                }
            }
            
            // If the trade update contains a full trades array, use it directly
            if (data.trades && Array.isArray(data.trades)) {
                console.log('Processing trades array from trade_update:', data.trades);
                updateTradesDisplay(data.trades);
            }
            
            // Update trade counters if provided
            if (data.trades_executed !== undefined || data.total_pnl !== undefined) {
                updateTradeCounters(data.trades_executed, data.total_pnl);
            }
        });

        // Handle arbitrage-specific trade updates
        socket.on('arbitrage_update', function(data) {
            console.log('üîÑ Received arbitrage_update:', data);
            
            // Update arbitrage trades display
            if (data.trades && Array.isArray(data.trades)) {
                console.log('Processing arbitrage trades:', data.trades);
                updateTradesDisplay(data.trades);
            }
            
            // Update profit and counters
            if (data.total_profit !== undefined || data.trades_count !== undefined) {
                updateTradeCounters(data.trades_count, data.total_profit);
            }
        });

        // Handle trade errors
        socket.on('trade_error', function(data) {
            console.error('‚ùå Received trade_error:', data);
            
            // Show error notification
            if (data.message) {
                showNotification({
                    title: 'Trade Error',
                    message: data.message,
                    type: 'error'
                });
            }
            
            // If trade details are provided, could show in a modal
            if (data.trade_details) {
                console.log('Trade error details:', data.trade_details);
            }
        });

        // Add stub functions for missing references
        function checkFunds() {
            console.log('Checking funds...');
            // Implement fund checking logic
        }

        function showWalletQR() {
            console.log('Showing wallet QR...');
            // Implement wallet QR display logic
        }

        function closeFundsAlert() {
            const modal = document.getElementById('funds-alert-modal');
            if (modal) modal.style.display = 'none';
        }

        function closeWalletQR() {
            const modal = document.getElementById('wallet-qr-modal');
            if (modal) modal.style.display = 'none';
        }

        function copyWalletAddress() {
            console.log('Copying wallet address...');
            // Implement copy functionality
        }

        function injectTestTrades() {
            console.log('Injecting test trades...');
            // Implement test trade injection
        }

        function updateRecentTrades(trade) {
            console.log('Updating recent trades with:', trade);
            // Implement recent trades update
        }

        function updateArbitrageTrades(data) {
            console.log('Updating arbitrage trades with:', data);
            // Implement arbitrage trades update
        }
        
        function updateTradesDisplay(trades) {
            console.log('Updating trades display with:', trades);
            
            // Update recent trades table
            const tradesTable = document.getElementById('trades-table');
            const arbitrageTable = document.getElementById('arbitrage-trades-table');
            
            if (tradesTable && trades && trades.length > 0) {
                // Clear existing rows
                tradesTable.innerHTML = '';
                
                // Add new trade rows (show last 10)
                const recentTrades = trades.slice(-10).reverse(); // Most recent first
                recentTrades.forEach(trade => {
                    const row = document.createElement('tr');
                    
                    // Format timestamp
                    const time = new Date(trade.timestamp).toLocaleTimeString();
                    
                    // Determine action and styling
                    const action = `${trade.buy_source} ‚Üí ${trade.sell_source}`;
                    const amount = `$${trade.trade_amount}`;
                    const profit = trade.realized_profit;
                    const profitFormatted = profit >= 0 ? `+$${profit.toFixed(4)}` : `-$${Math.abs(profit).toFixed(4)}`;
                    const statusClass = trade.success ? 'text-success' : 'text-error';
                    
                    row.innerHTML = `
                        <td>${time}</td>
                        <td>${action}</td>
                        <td>${amount}</td>
                        <td class="${statusClass}">${profitFormatted}</td>
                    `;
                    
                    tradesTable.appendChild(row);
                });
            } else if (tradesTable) {
                tradesTable.innerHTML = '<tr><td colspan="4" class="text-muted text-center">No trades yet</td></tr>';
            }
            
            // Update arbitrage trades table
            if (arbitrageTable && trades && trades.length > 0) {
                // Clear existing rows
                arbitrageTable.innerHTML = '';
                
                // Add arbitrage trade rows
                trades.forEach(trade => {
                    const row = document.createElement('tr');
                    
                    // Format timestamp
                    const time = new Date(trade.timestamp).toLocaleTimeString();
                    
                    // Trade details
                    const pair = trade.token_pair || 'SOL/USDC';
                    const buyDex = trade.buy_source || '-';
                    const sellDex = trade.sell_source || '-';
                    const amount = `$${trade.trade_amount || 0}`;
                    const profit = trade.realized_profit || 0;
                    const profitFormatted = profit >= 0 ? `+$${profit.toFixed(4)}` : `-$${Math.abs(profit).toFixed(4)}`;
                    const status = trade.success ? 
                        '<span class="badge badge-success">Success</span>' : 
                        '<span class="badge badge-error">Failed</span>';
                    
                    const profitClass = profit >= 0 ? 'text-success' : 'text-error';
                    
                    row.innerHTML = `
                        <td>${time}</td>
                        <td>${pair}</td>
                        <td>${buyDex}</td>
                        <td>${sellDex}</td>
                        <td>${amount}</td>
                        <td class="${profitClass}">${profitFormatted}</td>
                        <td>${status}</td>
                    `;
                    
                    arbitrageTable.appendChild(row);
                });
            } else if (arbitrageTable) {
                arbitrageTable.innerHTML = '<tr><td colspan="7" class="text-muted text-center">No arbitrage trades yet</td></tr>';
            }
        }
        
        function updateTradeCounters(tradesCount, totalPnl) {
            // Update arbitrage profit badge
            const profitBadge = document.getElementById('arbitrage-profit');
            if (profitBadge && totalPnl !== undefined) {
                const profit = parseFloat(totalPnl);
                profitBadge.innerHTML = `
                    <svg style="width: 16px; height: 16px; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                    </svg>
                    Total Profit: $${profit.toFixed(4)}
                `;
                profitBadge.className = profit >= 0 ? 'badge badge-success' : 'badge badge-error';
            }
            
            // Update trade count badge
            const countBadge = document.getElementById('arbitrage-count');
            if (countBadge && tradesCount !== undefined) {
                countBadge.innerHTML = `
                    <svg style="width: 14px; height: 14px; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"></path>
                        <path d="M18 17V9"></path>
                        <path d="M13 17V5"></path>
                        <path d="M8 17v-3"></path>
                    </svg>
                    Trades: ${tradesCount}
                `;
            }
            
            // Update success rate (assuming all trades are successful for now)
            const successBadge = document.getElementById('arbitrage-success-rate');
            if (successBadge && tradesCount !== undefined) {
                const successRate = tradesCount > 0 ? 100 : 0; // Simplified for now
                successBadge.innerHTML = `
                    <svg style="width: 14px; height: 14px; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <path d="M22 4L12 14.01l-3-3"></path>
                    </svg>
                    Success Rate: ${successRate}%
                `;
            }
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéâ DOM fully loaded and parsed');
            setTimeout(requestUpdate, 1000);
            // Also refresh wallet balances on page load
            setTimeout(refreshWalletBalance, 1500);
            // Fetch bot status via HTTP API as fallback to show start/stop buttons
            setTimeout(fetchBotStatusFallback, 2000);
        });

        // Fallback function to fetch bot status via HTTP API if WebSocket isn't working
        async function fetchBotStatusFallback() {
            try {
                console.log('üîÑ Fetching bot status via HTTP API...');
                const response = await fetch('/api/status');
                const statusData = await response.json();
                
                console.log('Bot status from API:', statusData);
                
                // Update button visibility based on status
                const startBtn = document.getElementById('start-bot');
                const stopBtn = document.getElementById('stop-bot');
                
                if (startBtn && stopBtn) {
                    if (statusData.running) {
                        // Bot is running - show stop button
                        startBtn.style.display = 'none';
                        stopBtn.style.display = 'inline-block';
                        stopBtn.disabled = false;
                        stopBtn.innerHTML = '‚èπÔ∏è Stop Bot';
                    } else {
                        // Bot is stopped - show start button
                        startBtn.style.display = 'inline-block';
                        stopBtn.style.display = 'none';
                        startBtn.disabled = false;
                        startBtn.innerHTML = '‚ñ∂Ô∏è Start Bot';
                    }
                    console.log('‚úÖ Updated button visibility based on bot status');
                }
                
                // Also update status badge
                const statusBadge = document.getElementById('status-badge');
                if (statusBadge) {
                    statusBadge.textContent = statusData.status || (statusData.running ? 'Running' : 'Stopped');
                    statusBadge.className = 'status-badge '; // Reset classes
                    statusBadge.classList.add(statusData.running ? 'status-running' : 'status-stopped');
                }
                
            } catch (error) {
                console.error('‚ùå Error fetching bot status:', error);
                
                // Default to showing start button if we can't get status
                const startBtn = document.getElementById('start-bot');
                const stopBtn = document.getElementById('stop-bot');
                
                if (startBtn && stopBtn) {
                    startBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    startBtn.disabled = false;
                    startBtn.innerHTML = '‚ñ∂Ô∏è Start Bot';
                    console.log('‚úÖ Defaulted to showing start button');
                }
            }
        }
    </script>
</body>
</html>
